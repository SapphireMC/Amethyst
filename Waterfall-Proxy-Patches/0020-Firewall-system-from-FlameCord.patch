From b6fbac55e47c016559e1044b17e5f82d22cddf8c Mon Sep 17 00:00:00 2001
From: DenaryDev <denaryplanet@gmail.com>
Date: Mon, 10 Jan 2022 00:39:35 +0500
Subject: [PATCH] Firewall system from FlameCord


diff --git a/api/src/main/java/net/md_5/bungee/api/ProxyServer.java b/api/src/main/java/net/md_5/bungee/api/ProxyServer.java
index 7c464176..436ff2b8 100644
--- a/api/src/main/java/net/md_5/bungee/api/ProxyServer.java
+++ b/api/src/main/java/net/md_5/bungee/api/ProxyServer.java
@@ -2,6 +2,7 @@ package net.md_5.bungee.api;
 
 import com.google.common.base.Preconditions;
 import io.sapphiremc.amethyst.Amethyst;
+import io.sapphiremc.amethyst.firewall.FirewallManager;
 import java.io.File;
 import java.net.InetSocketAddress;
 import java.net.SocketAddress;
@@ -353,5 +354,13 @@ public abstract class ProxyServer
      * @return the localized {@link BaseComponent}
      */
     public abstract BaseComponent[] getTranslationComponent(String name, Object... args);
+
+    /**
+     * Gets an instance of amethyst firewall manager
+     *
+     * @return firewall manager
+     * @see FirewallManager
+     */
+    public abstract FirewallManager getFirewallManager();
     // Amethyst end
 }
diff --git a/flame/src/main/java/io/sapphiremc/amethyst/Amethyst.java b/flame/src/main/java/io/sapphiremc/amethyst/Amethyst.java
index 934c0ccf..74dec507 100644
--- a/flame/src/main/java/io/sapphiremc/amethyst/Amethyst.java
+++ b/flame/src/main/java/io/sapphiremc/amethyst/Amethyst.java
@@ -2,6 +2,8 @@ package io.sapphiremc.amethyst;
 
 import io.sapphiremc.amethyst.conf.AmethystConfig;
 import io.sapphiremc.amethyst.conf.MessagesConfig;
+import io.sapphiremc.amethyst.firewall.FirewallManager;
+import java.util.Collection;
 import java.util.logging.Logger;
 import lombok.Getter;
 import net.md_5.bungee.config.ConfigurationProvider;
@@ -46,15 +48,45 @@ public class Amethyst {
      */
     @Getter
     private MessagesConfig messages;
+    /**
+     * Amethyst firewall manager.
+     * @see FirewallManager
+     */
+    @Getter
+    private FirewallManager firewallManager;
+    /**
+     * Firewall tick thread.
+     * @see FirewallManager#tick()
+     */
+    @Getter
+    private Thread firewallTickThread;
+
+    private boolean taskRunning;
 
     /**
      * This method is used by the proxy to initialize this
      * Doesn't use this if you don't know what you are doing
      */
-    public void load(Logger logger) {
+    public void load(Logger logger, Collection<String> whitelistedAddresses) {
+        this.taskRunning = false;
         this.provider = ConfigurationProvider.getProvider(YamlConfiguration.class);
         this.logger = logger;
         this.config = new AmethystConfig(provider);
         this.messages = new MessagesConfig(provider);
+        this.firewallManager = new FirewallManager(whitelistedAddresses);
+        this.taskRunning = true;
+
+        this.firewallTickThread = new Thread(() -> {
+            while (taskRunning) {
+                try {
+                    Thread.sleep(1000L);
+                    if (!taskRunning) return;
+
+                    firewallManager.tick();
+                } catch (Exception ignored) {
+                }
+            }
+        });
+        this.firewallTickThread.start();
     }
 }
diff --git a/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java b/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java
index e567be66..0955606a 100644
--- a/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java
+++ b/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java
@@ -1,5 +1,8 @@
 package io.sapphiremc.amethyst.conf;
 
+import java.util.Collection;
+import java.util.Arrays;
+import java.util.List;
 import net.md_5.bungee.config.ConfigurationProvider;
 
 /**
@@ -51,6 +54,37 @@ public class AmethystConfig extends AbstractYamlConfig {
      */
     public String maxVersion = "1.18.2";
 
+    /**
+     * Firewall status.
+     * true - enabled, false - disabled.
+     */
+    public boolean firewallEnabled = true;
+    /**
+     * Firewall cleaning notifications.
+     */
+    public boolean firewallNotify = true;
+    /**
+     * Blocked addresses cleanup interval.
+     */
+    public int firewallClearInterval = 60;
+    /**
+     * Firewall names.
+     */
+    public Collection<String> firewallNames = Arrays.asList("mcspam", "mcbot", "mcstorm", "dropbot", "theresabot");
+
+    /**
+     * Enable or disable InitialHandler logging.
+     */
+    public boolean logInitialHandler = false;
+    /**
+     * Enable or disable Exceptions logging.
+     */
+    public boolean logExceptions = false;
+    /**
+     * Enable or disable HaProxy logging.
+     */
+    public boolean logHaProxy = false;
+
     public AmethystConfig(ConfigurationProvider provider) {
         super(provider, "amethyst.yml");
         init();
@@ -60,6 +94,15 @@ public class AmethystConfig extends AbstractYamlConfig {
     @Override
     protected void loadContent()
     {
+        firewallEnabled = getBoolean("firewall.enabled", firewallEnabled);
+        firewallNotify = getBoolean("firewall.notify", firewallNotify);
+        firewallClearInterval = getInt("firewall.clear-interval", firewallClearInterval);
+        firewallNames = getStringList("firewall.names", (List<String>) firewallNames);
+
+        logInitialHandler = getBoolean("logger.initialHandler", logInitialHandler);
+        logExceptions = getBoolean("logger.exceptions", logExceptions);
+        logHaProxy = getBoolean("logger.haProxy", logHaProxy);
+
         alertEnabled = getBoolean( "modules.alert", alertEnabled );
         findEnabled = getBoolean( "modules.find", findEnabled );
         ipEnabled = getBoolean( "modules.ip", ipEnabled );
diff --git a/flame/src/main/java/io/sapphiremc/amethyst/firewall/FirewallManager.java b/flame/src/main/java/io/sapphiremc/amethyst/firewall/FirewallManager.java
new file mode 100644
index 00000000..6705414b
--- /dev/null
+++ b/flame/src/main/java/io/sapphiremc/amethyst/firewall/FirewallManager.java
@@ -0,0 +1,161 @@
+package io.sapphiremc.amethyst.firewall;
+
+import io.sapphiremc.amethyst.Amethyst;
+import java.net.InetSocketAddress;
+import java.net.SocketAddress;
+import java.util.ArrayList;
+import java.util.Collection;
+import java.util.Locale;
+import lombok.Getter;
+
+/**
+ * Firewall manager for proxy.
+ * Ported from FlameCord
+ */
+public class FirewallManager {
+    private final Amethyst core = Amethyst.getInstance();
+
+    /**
+     * List of whitelisted addresses.
+     */
+    @Getter
+    private final Collection<String> whitelistedAddresses = new ArrayList<>();
+    /**
+     * List of addresses protected by firewall.
+     */
+    @Getter
+    private final Collection<String> firewalled = new ArrayList<>();
+    /**
+     * Firewall address flush interval.
+     */
+    @Getter
+    private final int clearDelay;
+    /**
+     * Time until firewall addresses are cleared.
+     */
+    @Getter
+    private int untilNextClear;
+
+    public FirewallManager(Collection<String> whitelistedAddresses) {
+        this.whitelistedAddresses.addAll(whitelistedAddresses);
+        this.clearDelay = core.getConfig().firewallClearInterval;
+        this.untilNextClear = this.clearDelay;
+    }
+
+    /**
+     * Returns true if the address is in the whitelist,
+     * otherwise returns false.
+     *
+     * @param address address to check
+     * @return is the address in the whitelist
+     */
+    public boolean isWhitelisted(SocketAddress address) {
+        for (String whitelistedAddress : whitelistedAddresses) {
+            if (address.toString().endsWith(whitelistedAddress)) {
+                return true;
+            }
+        }
+
+        return false;
+    }
+
+    /**
+     * Adds the address to the list of addresses protected
+     * by the firewall.
+     *
+     * @param address address to add
+     */
+    public void addFirewalled(SocketAddress address) {
+        if (address == null) {
+            return;
+        }
+
+        if (core.getConfig().firewallEnabled && !isWhitelisted(address)) {
+            InetSocketAddress inetAddress = (InetSocketAddress) address;
+            String host = inetAddress.getHostString();
+
+            if (!this.firewalled.contains(host)) {
+                this.firewalled.add(host);
+                logAdded(address);
+            }
+        }
+    }
+
+    /**
+     * Logs information about adding an address.
+     *
+     * @param address logging address
+     */
+    public void logAdded(SocketAddress address) {
+        if (core.getConfig().firewallNotify) {
+            InetSocketAddress inetAddress = (InetSocketAddress) address;
+            String host = inetAddress.getHostString();
+
+            core.getLogger().info(host + " had been firewalled from the proxy!");
+        }
+    }
+
+    /**
+     * Logs information about blocking an address.
+     *
+     * @param address logging address
+     */
+    public void logBlocked(SocketAddress address) {
+        if (core.getConfig().firewallNotify) {
+            InetSocketAddress inetAddress = (InetSocketAddress) address;
+            String host = inetAddress.getHostString();
+
+            core.getLogger().info(host + " is firewalled from the proxy, request blocked!");
+        }
+    }
+
+    /**
+     * Returns true if the address is protected by a firewall,
+     * otherwise returns false.
+     *
+     * @param address address to check
+     * @return is the address protected by a firewall
+     */
+    public boolean isFirewalled(SocketAddress address) {
+        InetSocketAddress inetAddress = (InetSocketAddress) address;
+
+        return this.firewalled.contains(inetAddress.getHostString());
+    }
+
+    /**
+     * Returns true if the name is in the list of firewall names,
+     * otherwise returns false.
+     *
+     * @param name name to check
+     * @return is the name in the list of firewall name
+     */
+    public boolean isFirewalled(String name) {
+        Collection<String> firewallNames = core.getConfig().firewallNames;
+        for (String string : firewallNames) {
+            if (name.toLowerCase(Locale.ROOT).contains(string)) {
+                return true;
+            }
+        }
+
+        return false;
+    }
+
+    /**
+     * Update time until next clear.
+     */
+    public void tick() {
+        if (--untilNextClear <= 0) {
+            int size = this.firewalled.size();
+
+            if (size > 0) {
+                if (core.getConfig().firewallNotify) {
+                    core.getLogger().info(  size + " addresses had been automatically removed from the firewall!" );
+                }
+
+                this.firewalled.clear();
+            }
+
+            this.untilNextClear = clearDelay;
+        }
+    }
+}
diff --git a/flame/src/main/resources/amethyst.yml b/flame/src/main/resources/amethyst.yml
index 8b2bffc3..c8e7f85c 100644
--- a/flame/src/main/resources/amethyst.yml
+++ b/flame/src/main/resources/amethyst.yml
@@ -16,6 +16,36 @@ versions:
   # Default: 1.18.2
   max: "1.18.2"
 
+# Firewall configuration
+firewall:
+  # Enable firewall system?
+  enabled: true
+
+  # Notify in the console when a firewall is blocking addresses?
+  notify: true
+
+  # Blocked addresses cleanup interval.
+  clear-nverval: 60
+
+  # Firewall names
+  names:
+    - "mcspam"
+    - "mcbot"
+    - "mcstorm"
+    - "dropbot"
+    - "theresabot"
+
+# Logger configuration
+logger:
+  # Enable or disable InitialHandler logging.
+  initialHandler: false
+
+  # Enable or disable Exceptions logging.
+  exceptions: false
+
+  # Enable or disable HaProxy logging.
+  haProxy: false
+
 # Modules configuration
 # In this section you can enable or disable certain proxy modules
 modules:
diff --git a/proxy/src/main/java/net/md_5/bungee/BungeeCord.java b/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
index 7b7e42b5..131003a9 100644
--- a/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
+++ b/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
@@ -25,6 +25,7 @@ import io.sapphiremc.amethyst.BuildData;
 import io.sapphiremc.amethyst.Amethyst;
 import io.sapphiremc.amethyst.AmethystModulesManager;
 import io.sapphiremc.amethyst.api.protocol.ProtocolVersion;
+import io.sapphiremc.amethyst.firewall.FirewallManager;
 import java.io.File;
 import java.io.FileReader;
 import java.io.IOException;
@@ -293,7 +294,15 @@ public class BungeeCord extends ProxyServer
         pluginManager.loadPlugins();
         config.load();
 
-        Amethyst.getInstance().load(logger); // Amethyst - load our configs
+        // Amethyst start - firewall manager
+        Collection<String> whitelistedAddresses = new HashSet<>();
+
+        for ( ServerInfo server : getServersCopy().values() )
+        {
+            whitelistedAddresses.add( server.getSocketAddress().toString() );
+        }
+        // Amethyst end
+        Amethyst.getInstance().load( logger, whitelistedAddresses ); // Amethyst - load our configs
         AmethystModulesManager.registerModules(this); // Amethyst - register modules
         ProtocolVersion.register(); // Amethyst - configurable min and max versions
 
@@ -863,5 +872,11 @@ public class BungeeCord extends ProxyServer
     {
         return TextComponent.fromLegacyText( getTranslation( name, args ) );
     }
+
+    @Override
+    public FirewallManager getFirewallManager()
+    {
+        return getAmethyst().getFirewallManager();
+    }
     // Amethyst end
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/command/CommandReload.java b/proxy/src/main/java/net/md_5/bungee/command/CommandReload.java
index 1c696a7d..083bc116 100644
--- a/proxy/src/main/java/net/md_5/bungee/command/CommandReload.java
+++ b/proxy/src/main/java/net/md_5/bungee/command/CommandReload.java
@@ -3,8 +3,11 @@ package net.md_5.bungee.command;
 import io.sapphiremc.amethyst.Amethyst;
 import io.sapphiremc.amethyst.AmethystModulesManager;
 import io.sapphiremc.amethyst.api.protocol.ProtocolVersion;
+import java.util.Collection;
+import java.util.HashSet;
 import net.md_5.bungee.BungeeCord;
 import net.md_5.bungee.api.CommandSender;
+import net.md_5.bungee.api.config.ServerInfo;
 import net.md_5.bungee.api.connection.PendingConnection;
 import net.md_5.bungee.api.connection.ProxiedPlayer;
 import net.md_5.bungee.api.event.ProxyReloadEvent;
@@ -28,7 +31,15 @@ public class CommandReload extends Command
         proxy.startListeners();
         proxy.getPluginManager().callEvent( new ProxyReloadEvent( sender ) );
 
-        Amethyst.getInstance().load( BungeeCord.getInstance().getLogger() ); // Amethyst - load our configs
+        // Amethyst start - firewall manager
+        Collection<String> whitelistedAddresses = new HashSet<>();
+
+        for ( ServerInfo server : proxy.getServersCopy().values() )
+        {
+            whitelistedAddresses.add( server.getSocketAddress().toString() );
+        }
+        // Amethyst end
+        Amethyst.getInstance().load( BungeeCord.getInstance().getLogger(), whitelistedAddresses ); // Amethyst - load our configs
         AmethystModulesManager.registerModules( BungeeCord.getInstance() ); // Amethyst - register modules
         ProtocolVersion.register(); // Amethyst - register min and max supported versions
 
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index e4c927f1..5ec67c48 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -344,7 +344,7 @@ public class InitialHandler extends PacketHandler implements PendingConnection
         {
             case 1:
                 // Ping
-                if ( bungee.getConfig().isLogPings() )
+                if ( bungee.getConfig().isLogPings() && bungee.getAmethyst().getConfig().logInitialHandler ) // Amethyst - Option to fully disable InitialHandler logging.
                 {
                     bungee.getLogger().log( Level.INFO, "{0} has pinged", this );
                 }
@@ -353,7 +353,7 @@ public class InitialHandler extends PacketHandler implements PendingConnection
                 break;
             case 2:
                 // Login
-                if (BungeeCord.getInstance().getConfig().isLogInitialHandlerConnections() ) // Waterfall
+                if (BungeeCord.getInstance().getConfig().isLogInitialHandlerConnections() && bungee.getAmethyst().getConfig().logInitialHandler) // Waterfall  // Amethyst - Option to fully disable InitialHandler logging.
                 {
                     bungee.getLogger().log( Level.INFO, "{0} has connected", this );
                 }
@@ -387,6 +387,16 @@ public class InitialHandler extends PacketHandler implements PendingConnection
             disconnect( bungee.getTranslationComponent( "error.name-invalid" ) );
             return;
         }
+
+        // Amethyst start - Firewall and close if username is blocked
+        if ( BungeeCord.getInstance().getFirewallManager().isFirewalled( loginRequest.getData() ) )
+        {
+            BungeeCord.getInstance().getFirewallManager().addFirewalled( ch.getRemoteAddress() );
+            ch.close();
+            return;
+        }
+        // Amethyst end
+
         this.loginRequest = loginRequest;
 
         int limit = BungeeCord.getInstance().config.getPlayerLimit();
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/PingHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/PingHandler.java
index 6df3f3dd..d3300cbd 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/PingHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/PingHandler.java
@@ -57,6 +57,7 @@ public class PingHandler extends PacketHandler
     {
         if ( packet.packet == null )
         {
+            BungeeCord.getInstance().getFirewallManager().addFirewalled( channel.getRemoteAddress() ); // Amethyst - Firewall on unexpected packet
             throw new QuietException( "Unexpected packet received during ping process! " + BufUtil.dump( packet.buf, 16 ) );
         }
     }
diff --git a/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java b/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java
index 6d38de16..a3857778 100644
--- a/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java
+++ b/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java
@@ -44,7 +44,7 @@ public class HandlerBoss extends ChannelInboundHandlerAdapter
             channel = new ChannelWrapper( ctx );
             handler.connected( channel );
 
-            if ( !( handler instanceof InitialHandler || handler instanceof PingHandler ) )
+            if ( !( handler instanceof InitialHandler || handler instanceof PingHandler ) && ProxyServer.getInstance().getAmethyst().getConfig().logInitialHandler ) // Amethyst - Option to fully disable InitialHandler logging.
             {
                 ProxyServer.getInstance().getLogger().log( Level.INFO, "{0} has connected", handler );
             }
@@ -59,7 +59,7 @@ public class HandlerBoss extends ChannelInboundHandlerAdapter
             channel.markClosed();
             handler.disconnected( channel );
 
-            if ( !( handler instanceof InitialHandler || handler instanceof PingHandler ) )
+            if ( !( handler instanceof InitialHandler || handler instanceof PingHandler ) && ProxyServer.getInstance().getAmethyst().getConfig().logInitialHandler ) // Amethyst - Option to fully disable InitialHandler logging.
             {
                 ProxyServer.getInstance().getLogger().log( Level.INFO, "{0} has disconnected", handler );
             }
@@ -98,10 +98,13 @@ public class HandlerBoss extends ChannelInboundHandlerAdapter
                 {
                     InetSocketAddress newAddress = new InetSocketAddress( proxy.sourceAddress(), proxy.sourcePort() );
 
-                    ProxyServer.getInstance().getLogger().log( Level.FINE, "Set remote address via PROXY {0} -> {1}", new Object[]
+                    if ( ProxyServer.getInstance().getAmethyst().getConfig().logHaProxy ) // Amethyst - Option to fully disable InitialHandler logging.
                     {
-                        channel.getRemoteAddress(), newAddress
-                    } );
+                        ProxyServer.getInstance().getLogger().log( Level.FINE, "Set remote address via PROXY {0} -> {1}", new Object[]
+                        {
+                            channel.getRemoteAddress(), newAddress
+                        } );
+                    }
 
                     channel.setRemoteAddress( newAddress );
                 }
@@ -144,7 +147,14 @@ public class HandlerBoss extends ChannelInboundHandlerAdapter
     {
         if ( ctx.channel().isActive() )
         {
-            boolean logExceptions = !( handler instanceof PingHandler );
+            boolean logExceptions = ProxyServer.getInstance().getAmethyst().getConfig().logExceptions && !(handler instanceof PingHandler); // Amethyst - Option to fully disable exceptions logging.
+
+            // Amethyst start - Firewall system
+            if ( !(cause instanceof ReadTimeoutException) )
+            {
+                ProxyServer.getInstance().getFirewallManager().addFirewalled( ctx.channel().remoteAddress() );
+            }
+            // Amethyst end
 
             if ( logExceptions )
             {
diff --git a/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java b/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java
index 3d08e38a..454c57b1 100644
--- a/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java
+++ b/proxy/src/main/java/net/md_5/bungee/netty/PipelineUtils.java
@@ -61,8 +61,17 @@ public class PipelineUtils
         {
             SocketAddress remoteAddress = ( ch.remoteAddress() == null ) ? ch.parent().localAddress() : ch.remoteAddress();
 
+            // Amethyst - Firewall system
+            if ( BungeeCord.getInstance().getFirewallManager().isFirewalled( remoteAddress ) )
+            {
+                BungeeCord.getInstance().getFirewallManager().logBlocked( remoteAddress );
+                ch.close();
+                return;
+            }
+
             if ( BungeeCord.getInstance().getConnectionThrottle() != null && BungeeCord.getInstance().getConnectionThrottle().throttle( remoteAddress ) )
             {
+                BungeeCord.getInstance().getFirewallManager().addFirewalled( remoteAddress ); // Amethyst - Firewall throttled connections
                 ch.close();
                 return;
             }
diff --git a/query/src/main/java/net/md_5/bungee/query/QueryHandler.java b/query/src/main/java/net/md_5/bungee/query/QueryHandler.java
index a0b7a4ec..fd8683d5 100644
--- a/query/src/main/java/net/md_5/bungee/query/QueryHandler.java
+++ b/query/src/main/java/net/md_5/bungee/query/QueryHandler.java
@@ -70,6 +70,7 @@ public class QueryHandler extends SimpleChannelInboundHandler<DatagramPacket>
         ByteBuf in = msg.content();
         if ( in.readUnsignedByte() != 0xFE || in.readUnsignedByte() != 0xFD )
         {
+            ProxyServer.getInstance().getFirewallManager().addFirewalled( ctx.channel().remoteAddress() ); // Amethyst - Firewall system
             bungee.getLogger().log( Level.WARNING, "Query - Incorrect magic!: {0}", msg.sender() );
             ctx.close(); // Amethyst - Close on incorrect magic
             return;
-- 
2.35.1

