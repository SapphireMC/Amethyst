From e27d8919b43e6f605e37b3ae02284d88d864866b Mon Sep 17 00:00:00 2001
From: DenaryDev <denaryplanet@gmail.com>
Date: Sun, 6 Mar 2022 02:54:51 +0500
Subject: [PATCH] Option to allow invalid usernames


diff --git a/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java b/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java
index e992d378..b67b2aab 100644
--- a/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java
+++ b/flame/src/main/java/io/sapphiremc/amethyst/conf/AmethystConfig.java
@@ -140,6 +140,10 @@ public class AmethystConfig extends AbstractYamlConfig {
      * Custom bungee name.
      */
     public String bungeeName = "Amethyst";
+    /**
+     * Should usernames with invalid characters allowed?
+     */
+    public boolean allowInvalidUsernames = false;
 
     public AmethystConfig(ConfigurationProvider provider) {
         super(provider, "amethyst.yml");
diff --git a/flame/src/main/resources/amethyst.yml b/flame/src/main/resources/amethyst.yml
index dcf38c34..90e3a6a4 100644
--- a/flame/src/main/resources/amethyst.yml
+++ b/flame/src/main/resources/amethyst.yml
@@ -6,6 +6,9 @@ general:
   # Custom bungee name
   bungee-name: "Amethyst"
 
+  # Allow invalid usernames option
+  allow-invalid-usernames: false
+
 # Motd configuration
 motd:
   # Enable amethyst custom motd?
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index 4f17bbe6..86e53912 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -413,7 +413,7 @@ public class InitialHandler extends PacketHandler implements PendingConnection
         Preconditions.checkState( thisState == State.USERNAME, "Not expecting USERNAME" );
         thisState = State.PROCESSING_USERNAME; // Amethyst
 
-        if ( !AllowedCharacters.isValidName( loginRequest.getData(), onlineMode ) )
+        if ( !bungee.getAmethyst().getConfig().allowInvalidUsernames && !AllowedCharacters.isValidName( loginRequest.getData(), onlineMode ) ) // Amethyst - option to allow invalid usernames
         {
             disconnect( bungee.getTranslationComponent( "error.name-invalid" ) );
             return;
-- 
2.35.1

